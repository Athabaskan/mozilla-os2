## @file
# Top-level makefile
#

SUB_DEPTH = .
include $(KBUILD_PATH)/subheader.kmk

#
# Configure target prepares cached settings by putting them to a dedicated
# .kmk file that is included by Config.kmk. It is intended for variables that
# require running other programs (like text processors) to get their values
# so they would slow down the build process if evaluated each time kmk is run.
#

.PHONY: configure
configure: | $$(call DIRDEP,$$(dir $$(CACHED_CONFIG)))
	$(QUIET)$(ECHO) Obtaining and saving build settings to $(CACHED_CONFIG)...
	$(QUIET)$(RM) -f $(CACHED_CONFIG)

	$(QUIET)$(SHELL) -c ' \
	\
	MOZILLA_VERSION=`$(PERL) $(PATH_ROOT)/config/milestone.pl -topsrcdir $(PATH_ROOT) 2>nul` ; \
	MOZILLA_UAVERSION=`$(PERL) $(PATH_ROOT)/config/milestone.pl -topsrcdir $(PATH_ROOT) -uaversion 2>nul` ; \
	FIREFOX_VERSION=`cat $(PATH_ROOT)/browser/config/version.txt` ; \
	\
	test -f $(PATH_ROOT)/$(MOZ_BUILD_APP)/confvars.sh && . $(PATH_ROOT)/$(MOZ_BUILD_APP)/confvars.sh ; \
	\
	test -z "$$MOZ_BRANDING_DIRECTORY" || MOZ_BRANDING_DIRECTORY=$(MOZ_BUILD_APP)/branding/nightly ; \
	test -f $(PATH_ROOT)/$$MOZ_BRANDING_DIRECTORY/configure.sh && . $(PATH_ROOT)/$$MOZ_BRANDING_DIRECTORY/configure.sh ; \
	\
	$(shell $(SED) -nre " \
		s:^MOD_MAJOR_VERSION=+([0-9]+)$$:NSPR_MAJOR_VERSION=\1\;:p; \
		s:^MOD_MINOR_VERSION=+([0-9]+)$$:NSPR_MINOR_VERSION=\1\;:p; \
		s:^MOD_PATCH_VERSION=+([0-9]+)$$:NSPR_PATCH_VERSION=\1\;:p; \
		" < $(PATH_ROOT)/nsprpub/configure.in) \
	\
	$(APPEND_EXT) -n $(CACHED_CONFIG) \
		$(foreach var, $(SHELL_CONFIG_VARS), "$(var) ?= $$$(var)") \
	\
'
	$(QUIET)$(CAT) $(CACHED_CONFIG)

	$(QUIET)$(APPEND) $(CACHED_CONFIG) 'CACHED_CONFIG_INCLUDED := 1'
	$(QUIET)$(ECHO) Done.

BLDDIRS += $(call DIRDEP,$(dir $(CACHED_CONFIG)))
OTHER_CLEAN += $(CACHED_CONFIG)

#
# Global config headers.
#

USES += config-files

CONFIG_FILES += mozilla_confdefs_h

mozilla_confdefs_h_SOURCE             = mozilla-config.h.in
mozilla_confdefs_h_TARGET             = $(MOZILLA_CONFIG_H)
mozilla_confdefs_h_ALLDEFS_STATIC.os2 = mozilla-config.os2.h
mozilla_confdefs_h_ALLDEFS_VARS.os2   = \
    FIREFOX_VERSION MOZ_UPDATER MOZ_PHOENIX \
    MOZ_SAFE_BROWSING MOZ_SERVICES_AITC MOZ_SERVICES_NOTIFICATIONS \
    MOZ_SERVICES_SYNC MOZ_MEDIA_NAVIGATOR \
    MOZ_BUILD_APP MOZ_MACBUNDLE_ID MOZ_UPDATE_CHANNEL \
    MOZ_XUL MOZ_OMNIJAR \
    MOZILLA_VERSION_U=$(MOZILLA_VERSION)
mozilla_confdefs_h_ALLDEFS_VARS_QUOTED.os2 = \
    MOZILLA_VERSION MOZILLA_UAVERSION \
    MOZ_APP_UA_NAME MOZ_APP_UA_VERSION=$(MOZ_APP_VERSION) \
    MOZ_DISTRIBUTION_ID MOZ_UA_BUILDID MOZ_USER_DIR

CONFIG_FILES += xpcom_config_h xpcom_private_h

xpcom_config_h_MODE     = cdefs
xpcom_config_h_SOURCE   = xpcom/xpcom-config.h.in
xpcom_config_h_TARGET   = $(XPCOM_CONFIG_H)
xpcom_config_h_VARS.os2 = \
    CPP_THROW_NEW=throw() HAVE_CPP_2BYTE_WCHAR_T=1 HAVE_CPP_AMBIGUITY_RESOLVING_USING=1 \
    HAVE_CPP_CHAR16_T HAVE_CPP_DYNAMIC_CAST_TO_VOID_PTR=1 HAVE_CPP_PARTIAL_SPECIALIZATION=1 \
    HAVE_CPP_TROUBLE_COMPARING_TO_ZERO HAVE_STATVFS=1 NEED_CPP_UNUSED_IMPLEMENTATIONS=1 \
    NEW_H=<new> NS_ATTR_MALLOC=__attribute__((malloc)) \
    NS_WARN_UNUSED_RESULT=__attribute__((warn_unused_result))

xpcom_private_h_MODE       = cdefs
xpcom_private_h_SOURCE     = xpcom/xpcom-private.h.in
xpcom_private_h_TARGET     = $(XPCOM_PRIVATE_H)
xpcom_private_h_VARS.os2 = \
    HAVE_GETPAGESIZE=1 HAVE_ICONV HAVE_ICONV_WITH_CONST_INPUT HAVE_MBRTOWC=1 \
    HAVE_SYS_MOUNT_H HAVE_SYS_VFS_H=1 HAVE_WCRTOMB=1

#
# Install global headers.
#

INSTALLS += global_exports

global_exports_INST     = include/
global_exports_SOURCES += \
    $(MOZILLA_CONFIG_H) \
    config/nsStaticComponents.h \
    $(XPCOM_CONFIG_H)

#
# Include sub-makefiles.
#

# tier base
INCLUDE_SUBDIRS += build mfbt modules/zlib mozglue memory/mozalloc

# tier nspr
INCLUDE_SUBDIRS += nsprpub

# tier js
INCLUDE_SUBDIRS += js/src

# tier platform
INCLUDE_SUBDIRS += \
    xpcom modules/libpref intl netwerk ipc js/xpconnect modules/libjar \
    caps dom widget toolkit gfx content layout docshell accessible \
    xpfe/appshell startupcache

include $(FILE_SUB_FOOTER)
